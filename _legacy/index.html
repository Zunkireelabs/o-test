<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Orca</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    /* Dashboard Layout */
    .dashboard {
      height: 100vh;
      display: flex;
      background: white;
    }
    .dashboard-sidebar {
      width: 240px;
      background: #f7f7f7;
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.2s ease;
    }
    .dashboard.collapsed .dashboard-sidebar {
      width: 68px;
    }
    .sidebar-header {
      padding: 20px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 10px;
      overflow: hidden;
    }
    .sidebar-brand img {
      width: 28px;
      height: 28px;
      flex-shrink: 0;
    }
    .sidebar-brand span {
      font-size: 20px;
      font-weight: 600;
      color: #111;
      white-space: nowrap;
      transition: opacity 0.2s;
    }
    .dashboard.collapsed .sidebar-brand span {
      opacity: 0;
      width: 0;
    }
    .collapse-btn {
      background: transparent;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    .collapse-btn:hover {
      background: #ebebeb;
      color: #111;
    }
    .collapse-btn svg {
      width: 18px;
      height: 18px;
    }
    .dashboard.collapsed .collapse-btn {
      display: none;
    }
    /* Logo hover to show expand icon when collapsed */
    .sidebar-brand {
      position: relative;
      cursor: pointer;
    }
    .sidebar-brand .expand-icon {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 20px;
      height: 20px;
      color: #6b7280;
    }
    .dashboard.collapsed .sidebar-brand:hover img {
      opacity: 0;
    }
    .dashboard.collapsed .sidebar-brand:hover .expand-icon {
      display: block;
    }
    .sidebar-nav {
      flex: 1;
      padding: 8px 12px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: 8px;
      color: #374151;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border: none;
      background: transparent;
      width: 100%;
      text-align: left;
      white-space: nowrap;
      overflow: hidden;
    }
    .nav-item:hover {
      background: #f3f4f6;
    }
    .nav-item.active {
      background: #111;
      color: white;
    }
    .nav-item svg {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }
    .nav-item span {
      transition: opacity 0.2s;
    }
    .dashboard.collapsed .nav-item {
      justify-content: center;
      padding: 12px;
    }
    .dashboard.collapsed .nav-item span {
      opacity: 0;
      width: 0;
      overflow: hidden;
    }
    .sidebar-footer {
      padding: 12px;
    }
    .dashboard-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .dashboard-header {
      height: 60px;
      background: transparent;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding: 0 24px;
      flex-shrink: 0;
    }
    .dashboard-header-right {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .dashboard-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #22c55e;
    }
    .status-dot.offline {
      background: #ef4444;
    }
    .dashboard-user {
      font-size: 14px;
      font-weight: 500;
      color: #111;
    }
    .dashboard-logout {
      background: transparent;
      border: none;
      color: #6b7280;
      padding: 6px 14px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
    }
    .dashboard-logout:hover {
      background: #f3f4f6;
      color: #111;
    }
    .dashboard-main {
      flex: 1;
      overflow-y: auto;
      padding: 0 40px 32px;
      display: flex;
      flex-direction: column;
    }
    .section {
      display: none;
      max-width: 800px;
    }
    .section.active {
      display: block;
    }
    .section-header {
      margin-bottom: 24px;
    }
    .section-title {
      font-size: 24px;
      font-weight: 600;
      color: #111;
      margin-bottom: 4px;
    }
    .section-subtitle {
      font-size: 14px;
      color: #6b7280;
    }
    .section-card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }
    input, textarea, select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: #2563eb;
    }
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    button {
      background: #2563eb;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #1d4ed8;
    }
    button:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }
    button.secondary {
      background: #6b7280;
    }
    button.secondary:hover {
      background: #4b5563;
    }
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 16px;
    }
    .alert.success {
      background: #dcfce7;
      color: #166534;
    }
    .alert.error {
      background: #fee2e2;
      color: #991b1b;
    }
    .alert.info {
      background: #dbeafe;
      color: #1e40af;
    }
    .profile-field {
      margin-bottom: 12px;
    }
    .profile-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .profile-value {
      font-size: 15px;
      color: #111827;
      margin-top: 2px;
    }
    .job-item {
      padding: 12px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    .job-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .job-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }
    .job-status.completed {
      background: #dcfce7;
      color: #166534;
    }
    .job-status.processing {
      background: #fef3c7;
      color: #92400e;
    }
    .job-status.failed {
      background: #fee2e2;
      color: #991b1b;
    }
    .job-status.pending {
      background: #e5e7eb;
      color: #374151;
    }
    .job-details {
      font-size: 13px;
      color: #6b7280;
      margin-top: 8px;
    }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 8px 16px;
      border-radius: 8px;
      background: #e5e7eb;
      color: #374151;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .tab.active {
      background: #2563eb;
      color: white;
    }
    .hidden {
      display: none !important;
    }
    .embed-code {
      background: #1f2937;
      color: #e5e7eb;
      padding: 16px;
      border-radius: 8px;
      font-size: 13px;
      font-family: monospace;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .copy-btn {
      margin-top: 10px;
      font-size: 13px;
    }

    /* New Task Section - Centered Layout */
    #section-newtask {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      max-width: none;
    }
    #section-newtask.active {
      display: flex;
    }
    .newtask-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      width: 100%;
    }
    .newtask-heading {
      font-size: 36px;
      font-weight: 500;
      color: #111;
      margin-bottom: 32px;
      text-align: center;
      font-style: italic;
      font-family: Georgia, 'Times New Roman', serif;
    }
    .newtask-input-container {
      width: 100%;
      max-width: 680px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 16px;
      padding: 16px 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .newtask-input {
      width: 100%;
      border: none;
      outline: none;
      font-size: 16px;
      color: #111;
      background: transparent;
      resize: none;
      min-height: 24px;
      font-family: inherit;
    }
    .newtask-input::placeholder {
      color: #9ca3af;
    }
    .newtask-input-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid #f3f4f6;
    }
    .newtask-input-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .newtask-input-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .newtask-action-btn {
      background: transparent;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: #6b7280;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .newtask-action-btn:hover {
      background: #f3f4f6;
      color: #111;
    }
    .newtask-action-btn svg {
      width: 20px;
      height: 20px;
    }
    .newtask-submit-btn {
      background: #111;
      border: none;
      padding: 8px;
      cursor: pointer;
      color: white;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.15s;
    }
    .newtask-submit-btn:hover {
      background: #333;
    }
    .newtask-submit-btn svg {
      width: 18px;
      height: 18px;
    }
    .newtask-chips {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 24px;
      max-width: 680px;
    }
    .newtask-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 50px;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      cursor: pointer;
      transition: all 0.15s;
    }
    .newtask-chip:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    .newtask-chip svg {
      width: 18px;
      height: 18px;
      color: #6b7280;
    }

    /* Login Page - Manus-style layout */
    .login-page {
      height: 100vh;
      background: #f5f5f0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    /* Particle wave canvas */
    .particle-wave-canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
    }

    /* Ensure content is above the background */
    .login-header,
    .login-main,
    .login-footer {
      position: relative;
      z-index: 1;
    }
    .login-header {
      flex-shrink: 0;
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .login-brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .login-brand img {
      width: 28px;
      height: 28px;
    }
    .login-brand span {
      font-size: 20px;
      font-weight: 600;
      color: #111;
    }
    .login-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 0 20px;
      overflow-y: auto;
    }
    .login-icon {
      width: 64px;
      height: 64px;
      margin-bottom: 20px;
    }
    .login-title {
      font-size: 26px;
      font-weight: 700;
      color: #111;
      margin-bottom: 6px;
      text-align: center;
    }
    .login-subtitle {
      font-size: 15px;
      color: #6b7280;
      margin-bottom: 24px;
      text-align: center;
    }
    .login-card {
      width: 100%;
      max-width: 380px;
    }
    .oauth-btn {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      padding: 12px 20px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: #111;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 10px;
    }
    .oauth-btn:hover {
      background: #f9fafb;
      border-color: #d1d5db;
    }
    .oauth-btn img {
      width: 18px;
      height: 18px;
    }
    .oauth-btn svg {
      width: 18px;
      height: 18px;
    }
    .divider {
      display: flex;
      align-items: center;
      margin: 16px 0;
      color: #9ca3af;
      font-size: 13px;
    }
    .divider::before,
    .divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #e5e7eb;
    }
    .divider span {
      padding: 0 14px;
    }
    .login-card .form-group {
      margin-bottom: 12px;
    }
    .login-card input {
      width: 100%;
      padding: 12px 14px;
      font-size: 14px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: white;
    }
    .login-card input:focus {
      outline: none;
      border-color: #111;
      box-shadow: none;
    }
    .login-card input::placeholder {
      color: #9ca3af;
    }
    .login-btn {
      width: 100%;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      border-radius: 10px;
      background: #6b7280;
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      margin-top: 4px;
    }
    .login-btn:hover {
      background: #4b5563;
    }
    .login-footer {
      flex-shrink: 0;
      padding: 16px 32px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    .login-footer-brand {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: #9ca3af;
    }
    .login-footer-brand img {
      width: 18px;
      height: 18px;
    }
    .login-footer-brand span {
      color: #111;
      font-weight: 500;
    }
    .login-footer-links {
      display: flex;
      align-items: center;
      gap: 20px;
      font-size: 12px;
      color: #6b7280;
    }
    .login-footer-links a {
      color: #6b7280;
      text-decoration: none;
    }
    .login-footer-links a:hover {
      text-decoration: underline;
    }

    /* Hide header on login page */
    body.login-active .header {
      display: none;
    }

    /* API Status on login page */
    .login-api-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #6b7280;
    }

    /* File Upload / Drop Zone */
    .drop-zone {
      border: 2px dashed #d1d5db;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    .drop-zone:hover {
      border-color: #2563eb;
      background: #f0f4ff;
    }
    .drop-zone.drag-over {
      border-color: #2563eb;
      background: #eff6ff;
      border-style: solid;
    }
    .drop-zone-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      color: #9ca3af;
    }
    .drop-zone-text {
      font-size: 15px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 4px;
    }
    .drop-zone-hint {
      font-size: 13px;
      color: #9ca3af;
    }
    .file-preview {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      margin-top: 16px;
    }
    .file-preview-icon {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 18px;
    }
    .file-preview-icon.document { background: #dbeafe; }
    .file-preview-icon.image { background: #dcfce7; }
    .file-preview-icon.audio { background: #fef3c7; }
    .file-preview-icon.video { background: #fce7f3; }
    .file-preview-info {
      flex: 1;
      min-width: 0;
    }
    .file-preview-name {
      font-size: 14px;
      font-weight: 500;
      color: #111;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .file-preview-meta {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 2px;
    }
    .file-category-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .file-category-badge.document { background: #dbeafe; color: #1e40af; }
    .file-category-badge.image { background: #dcfce7; color: #166534; }
    .file-category-badge.audio { background: #fef3c7; color: #92400e; }
    .file-category-badge.video { background: #fce7f3; color: #9d174d; }
    .file-preview-remove {
      background: transparent;
      border: none;
      padding: 4px;
      cursor: pointer;
      color: #9ca3af;
      border-radius: 4px;
      display: flex;
      align-items: center;
    }
    .file-preview-remove:hover {
      color: #ef4444;
      background: #fee2e2;
    }

    /* Integrations Grid */
    .integrations-search {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 10px;
      margin-bottom: 20px;
      background: #fafafa;
    }
    .integrations-search svg {
      width: 18px;
      height: 18px;
      color: #9ca3af;
      flex-shrink: 0;
    }
    .integrations-search input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 14px;
      color: #111;
      width: 100%;
      padding: 0;
    }
    .integrations-search input::placeholder {
      color: #9ca3af;
    }
    .category-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .category-tab {
      padding: 6px 14px;
      border-radius: 50px;
      background: #f3f4f6;
      color: #374151;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .category-tab:hover {
      background: #e5e7eb;
    }
    .category-tab.active {
      background: #111;
      color: white;
    }
    .connected-section {
      margin-bottom: 28px;
    }
    .connected-section-title {
      font-size: 13px;
      font-weight: 600;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    .app-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }
    .app-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      transition: all 0.15s;
      background: white;
    }
    .app-card:hover {
      border-color: #d1d5db;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .app-card.connected {
      border-color: #bbf7d0;
      background: #f0fdf4;
    }
    .app-card-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: #f3f4f6;
      overflow: hidden;
    }
    .app-card-icon img {
      width: 24px;
      height: 24px;
    }
    .app-card-icon .fallback-icon {
      font-size: 20px;
    }
    .app-card-info {
      flex: 1;
      min-width: 0;
    }
    .app-card-name {
      font-size: 14px;
      font-weight: 600;
      color: #111;
    }
    .app-card-desc {
      font-size: 12px;
      color: #6b7280;
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .app-card-account {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #374151;
      margin-top: 4px;
    }
    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .connection-dot.green { background: #22c55e; }
    .connection-dot.red { background: #ef4444; }
    .connection-dot.gray { background: #9ca3af; }
    .app-card-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      flex-shrink: 0;
    }
    .connect-btn {
      background: #111;
      color: white;
      border: none;
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .connect-btn:hover {
      background: #333;
    }
    .connect-btn.coming-soon {
      background: #e5e7eb;
      color: #9ca3af;
      cursor: not-allowed;
    }
    .connect-btn.coming-soon:hover {
      background: #e5e7eb;
    }
    .disconnect-btn {
      background: transparent;
      color: #dc2626;
      border: 1px solid #fecaca;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .disconnect-btn:hover {
      background: #fef2f2;
    }
    .sync-btn {
      background: transparent;
      color: #2563eb;
      border: 1px solid #bfdbfe;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      white-space: nowrap;
    }
    .sync-btn:hover {
      background: #eff6ff;
    }

    /* Modal Overlay */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-overlay.hidden {
      display: none !important;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 28px;
      width: 100%;
      max-width: 520px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.15);
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: 600;
      color: #111;
    }
    .modal-close {
      background: transparent;
      border: none;
      padding: 6px;
      cursor: pointer;
      color: #6b7280;
      border-radius: 6px;
      display: flex;
      align-items: center;
    }
    .modal-close:hover {
      background: #f3f4f6;
      color: #111;
    }
    /* Toast notification */
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      z-index: 2000;
      animation: toast-in 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .toast.success { background: #dcfce7; color: #166534; }
    .toast.error { background: #fee2e2; color: #991b1b; }
    @keyframes toast-in {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <!-- Login View -->
  <div id="loginView" class="login-page">
    <!-- Particle wave background -->
    <canvas id="particleWave" class="particle-wave-canvas"></canvas>

    <!-- Header with brand and API status -->
    <div class="login-header">
      <div class="login-brand">
        <img src="assets/orca-icon.png" alt="Orca">
        <span>orca</span>
      </div>
      <div class="login-api-status">
        <div class="status-dot" id="loginApiStatus"></div>
        <span id="loginApiStatusText">Checking...</span>
      </div>
    </div>

    <!-- Main content -->
    <div class="login-main">
      <img src="assets/orca-icon.png" alt="Orca" class="login-icon">
      <h1 class="login-title">Sign in or sign up</h1>
      <p class="login-subtitle">Start using Orca</p>

      <div class="login-card">
        <div id="loginAlerts"></div>

        <!-- OAuth Buttons (non-functional) -->
        <button type="button" class="oauth-btn" onclick="showOAuthMessage()">
          <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Continue with Google
        </button>

        <button type="button" class="oauth-btn" onclick="showOAuthMessage()">
          <svg viewBox="0 0 23 23"><path fill="#f35325" d="M1 1h10v10H1z"/><path fill="#81bc06" d="M12 1h10v10H12z"/><path fill="#05a6f0" d="M1 12h10v10H1z"/><path fill="#ffba08" d="M12 12h10v10H12z"/></svg>
          Continue with Microsoft
        </button>

        <button type="button" class="oauth-btn" onclick="showOAuthMessage()">
          <svg viewBox="0 0 24 24" fill="#000"><path d="M18.71 19.5c-.83 1.24-1.71 2.45-3.05 2.47-1.34.03-1.77-.79-3.29-.79-1.53 0-2 .77-3.27.82-1.31.05-2.3-1.32-3.14-2.53C4.25 17 2.94 12.45 4.7 9.39c.87-1.52 2.43-2.48 4.12-2.51 1.28-.02 2.5.87 3.29.87.78 0 2.26-1.07 3.81-.91.65.03 2.47.26 3.64 1.98-.09.06-2.17 1.28-2.15 3.81.03 3.02 2.65 4.03 2.68 4.04-.03.07-.42 1.44-1.38 2.83M13 3.5c.73-.83 1.94-1.46 2.94-1.5.13 1.17-.34 2.35-1.04 3.19-.69.85-1.83 1.51-2.95 1.42-.15-1.15.41-2.35 1.05-3.11z"/></svg>
          Continue with Apple
        </button>

        <div class="divider"><span>Or</span></div>

        <!-- Email/Password Form -->
        <form id="loginForm">
          <div class="form-group">
            <input type="email" id="loginEmail" placeholder="Enter your email address" required>
          </div>
          <div class="form-group">
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
          </div>
          <button type="submit" class="login-btn">Continue</button>
        </form>
      </div>
    </div>

    <!-- Footer -->
    <div class="login-footer">
      <div class="login-footer-brand">
        <img src="assets/orca-icon.png" alt="Orca">
        <span>Orca</span>
      </div>
      <div class="login-footer-links">
        <a href="#">Terms of service</a>
        <a href="#">Privacy policy</a>
        <span>&copy;2026 Orca</span>
      </div>
    </div>
  </div>

  <!-- Dashboard View -->
  <div id="dashboardView" class="dashboard hidden">
    <!-- Sidebar -->
    <div class="dashboard-sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand" onclick="expandSidebarIfCollapsed()">
          <img src="assets/orca-icon.png" alt="Orca">
          <span>orca</span>
          <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" /><line x1="9" y1="3" x2="9" y2="21" /></svg>
        </div>
        <button class="collapse-btn" onclick="toggleSidebar()" title="Collapse sidebar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2" /><line x1="9" y1="3" x2="9" y2="21" /></svg>
        </button>
      </div>
      <div class="sidebar-nav">
        <button class="nav-item active" onclick="showSection('newtask')" data-section="newtask" title="New Task">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" /></svg>
          <span>New Task</span>
        </button>
        <button class="nav-item" onclick="showSection('ingest')" data-section="ingest" title="Ingest Data">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
          <span>Ingest Data</span>
        </button>
        <button class="nav-item" onclick="showSection('jobs')" data-section="jobs" title="Ingestion Jobs">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 12h16.5m-16.5 3.75h16.5M3.75 19.5h16.5M5.625 4.5h12.75a1.875 1.875 0 010 3.75H5.625a1.875 1.875 0 010-3.75z" /></svg>
          <span>Ingestion Jobs</span>
        </button>
        <button class="nav-item" onclick="showSection('knowledge')" data-section="knowledge" title="Knowledge Base">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>
          <span>Knowledge Base</span>
        </button>
        <button class="nav-item" onclick="showSection('widget')" data-section="widget" title="Widget Config">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
          <span>Widget Config</span>
        </button>
        <button class="nav-item" onclick="showSection('embed')" data-section="embed" title="Embed Code">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" /></svg>
          <span>Embed Code</span>
        </button>
        <button class="nav-item" onclick="showSection('connectors')" data-section="connectors" title="Integrations">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 01-.657.643 48.39 48.39 0 01-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 01-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 00-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 01-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 00.657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 01-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 005.427-.63 48.05 48.05 0 00.582-4.717.532.532 0 00-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 00.658-.663 48.422 48.422 0 00-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 01-.61-.58v0z" /></svg>
          <span>Integrations</span>
        </button>
      </div>
      <div class="sidebar-footer">
        <button class="nav-item" onclick="showSection('profile')" data-section="profile" title="Profile">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
          <span>Profile</span>
        </button>
      </div>
    </div>

    <!-- Content Area -->
    <div class="dashboard-content">
      <!-- Header -->
      <div class="dashboard-header">
        <div class="dashboard-header-right">
          <div class="dashboard-status">
            <div class="status-dot" id="apiStatus"></div>
            <span id="apiStatusText">Checking...</span>
          </div>
          <span class="dashboard-user" id="headerUser">-</span>
          <button class="dashboard-logout" onclick="logout()">Logout</button>
        </div>
      </div>

      <!-- Main Content -->
      <div class="dashboard-main">
        <div id="alerts"></div>

        <!-- New Task Section -->
        <div id="section-newtask" class="section active">
          <div class="newtask-container">
            <h1 class="newtask-heading">What can I do for you?</h1>

            <div class="newtask-input-container">
              <textarea class="newtask-input" placeholder="Ask anything or start a task..." rows="1" id="newtaskInput"></textarea>
              <div class="newtask-input-actions">
                <div class="newtask-input-left">
                  <button class="newtask-action-btn" title="Add attachment">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
                  </button>
                  <button class="newtask-action-btn" title="Tools">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" /></svg>
                  </button>
                </div>
                <div class="newtask-input-right">
                  <button class="newtask-submit-btn" title="Submit">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5L12 3m0 0l7.5 7.5M12 3v18" /></svg>
                  </button>
                </div>
              </div>
            </div>

            <div class="newtask-chips">
              <button class="newtask-chip" onclick="showSection('ingest'); showIngestTab('url');">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 011.242 7.244l-4.5 4.5a4.5 4.5 0 01-6.364-6.364l1.757-1.757m13.35-.622l1.757-1.757a4.5 4.5 0 00-6.364-6.364l-4.5 4.5a4.5 4.5 0 001.242 7.244" /></svg>
                Ingest URL
              </button>
              <button class="newtask-chip" onclick="showSection('ingest'); showIngestTab('text');">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
                Add Text
              </button>
              <button class="newtask-chip" onclick="showSection('ingest'); showIngestTab('file');">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                Upload File
              </button>
              <button class="newtask-chip" onclick="showSection('widget')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Configure Widget
              </button>
              <button class="newtask-chip" onclick="showSection('embed')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17.25 6.75L22.5 12l-5.25 5.25m-10.5 0L1.5 12l5.25-5.25m7.5-3l-4.5 16.5" /></svg>
                Get Embed Code
              </button>
              <button class="newtask-chip" onclick="showSection('connectors')">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.25 6.087c0-.355.186-.676.401-.959.221-.29.349-.634.349-1.003 0-1.036-1.007-1.875-2.25-1.875s-2.25.84-2.25 1.875c0 .369.128.713.349 1.003.215.283.401.604.401.959v0a.64.64 0 01-.657.643 48.39 48.39 0 01-4.163-.3c.186 1.613.293 3.25.315 4.907a.656.656 0 01-.658.663v0c-.355 0-.676-.186-.959-.401a1.647 1.647 0 00-1.003-.349c-1.036 0-1.875 1.007-1.875 2.25s.84 2.25 1.875 2.25c.369 0 .713-.128 1.003-.349.283-.215.604-.401.959-.401v0c.31 0 .555.26.532.57a48.039 48.039 0 01-.642 5.056c1.518.19 3.058.309 4.616.354a.64.64 0 00.657-.643v0c0-.355-.186-.676-.401-.959a1.647 1.647 0 01-.349-1.003c0-1.035 1.008-1.875 2.25-1.875 1.243 0 2.25.84 2.25 1.875 0 .369-.128.713-.349 1.003-.215.283-.4.604-.4.959v0c0 .333.277.599.61.58a48.1 48.1 0 005.427-.63 48.05 48.05 0 00.582-4.717.532.532 0 00-.533-.57v0c-.355 0-.676.186-.959.401-.29.221-.634.349-1.003.349-1.035 0-1.875-1.007-1.875-2.25s.84-2.25 1.875-2.25c.37 0 .713.128 1.003.349.283.215.604.401.96.401v0a.656.656 0 00.658-.663 48.422 48.422 0 00-.37-5.36c-1.886.342-3.81.574-5.766.689a.578.578 0 01-.61-.58v0z" /></svg>
                Connect App
              </button>
            </div>
          </div>
        </div>

        <!-- Ingest Data Section -->
        <div id="section-ingest" class="section">
          <div class="section-header">
            <h1 class="section-title">Ingest Data</h1>
            <p class="section-subtitle">Add content to your knowledge base via URL, text, or file upload. Manage API keys.</p>
          </div>
          <div class="section-card">
            <div class="tabs">
              <button class="tab active" onclick="showIngestTab('url')" data-ingest-tab="url">URL</button>
              <button class="tab" onclick="showIngestTab('text')" data-ingest-tab="text">Text</button>
              <button class="tab" onclick="showIngestTab('file')" data-ingest-tab="file">Files</button>
              <button class="tab" onclick="showIngestTab('apikeys')" data-ingest-tab="apikeys">API Keys</button>
            </div>
            <form id="ingestUrlForm">
              <div class="form-group">
                <label>URL to Crawl</label>
                <input type="url" id="ingestUrl" placeholder="https://yoursite.com/about" required>
              </div>
              <div class="form-group">
                <label>Max Pages</label>
                <input type="number" id="maxPages" value="1" min="1" max="50">
              </div>
              <button type="submit">Ingest URL</button>
            </form>
            <form id="ingestTextForm" class="hidden">
              <div class="form-group">
                <label>Title</label>
                <input type="text" id="textTitle" placeholder="About Us" required>
              </div>
              <div class="form-group">
                <label>Content</label>
                <textarea id="textContent" placeholder="Enter your content here..." required></textarea>
              </div>
              <button type="submit">Ingest Text</button>
            </form>
            <div id="ingestFileForm" class="hidden">
              <div id="fileDropZone" class="drop-zone">
                <svg class="drop-zone-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
                <div class="drop-zone-text">Drop files here or click to browse</div>
                <div class="drop-zone-hint">PDF, Word, Excel, PowerPoint, CSV, TXT, images, audio, video</div>
                <input type="file" id="fileInput" style="display: none;" accept=".pdf,.docx,.pptx,.xlsx,.csv,.txt,.md,.json,.jpg,.jpeg,.png,.gif,.webp,.bmp,.tiff,.mp3,.wav,.m4a,.ogg,.flac,.webm,.mp4,.mov">
              </div>
              <div id="filePreview" class="hidden"></div>
              <div class="btn-group">
                <button type="button" id="uploadFileBtn" onclick="uploadFile()" disabled>Upload File</button>
              </div>
            </div>
            <div id="ingestApiKeysForm" class="hidden">
              <!-- Client API Key -->
              <div style="margin-bottom: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; color: #111; margin-bottom: 4px;">Client API Key</h3>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">Use this key for programmatic API access (e.g. ingestion via curl).</p>
                <div style="display: flex; align-items: center; gap: 8px;">
                  <input type="text" id="clientApiKeyDisplay" readonly style="flex: 1; background: #f9fafb; font-family: monospace; font-size: 13px;" value="Loading...">
                  <button type="button" onclick="copyClientApiKey()" style="font-size: 13px; padding: 10px 16px; white-space: nowrap;">Copy</button>
                </div>
                <div id="clientApiKeyFull" class="hidden" style="margin-top: 10px;">
                  <div class="alert success" style="margin-bottom: 8px; font-size: 13px;">New key generated. Copy it now â€” it won't be shown again.</div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="text" id="clientApiKeyFullValue" readonly style="flex: 1; background: #f0fdf4; border-color: #86efac; font-family: monospace; font-size: 13px;">
                    <button type="button" onclick="copyNewClientApiKey()" style="font-size: 13px; padding: 10px 16px; white-space: nowrap;">Copy</button>
                  </div>
                </div>
                <div style="margin-top: 10px;">
                  <button type="button" onclick="regenerateApiKey()" style="background: #dc2626; font-size: 13px; padding: 8px 16px;">Regenerate Key</button>
                </div>
              </div>
              <!-- Third-Party Keys -->
              <div style="border-top: 1px solid #e5e7eb; padding-top: 24px;">
                <h3 style="font-size: 16px; font-weight: 600; color: #111; margin-bottom: 4px;">Third-Party Keys</h3>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">Provide your own OpenAI key for image, audio, and video file extraction. If not set, the platform key is used.</p>
                <div id="openaiKeyStatus" style="font-size: 13px; color: #6b7280; margin-bottom: 10px;"></div>
                <div style="margin-bottom: 10px; position: relative;">
                  <label style="margin-bottom: 6px;">OpenAI API Key</label>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="position: relative; flex: 1;">
                      <input type="password" id="openaiKeyInput" placeholder="sk-..." style="width: 100%; padding-right: 40px; font-family: monospace; font-size: 13px;">
                      <button type="button" onclick="toggleOpenAIKeyVisibility()" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; padding: 4px; cursor: pointer; color: #6b7280; display: flex; align-items: center;" title="Toggle visibility">
                        <svg id="openaiKeyEyeIcon" xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="btn-group" style="margin-top: 12px;">
                  <button type="button" onclick="saveOpenAIKey()">Save Key</button>
                  <button type="button" class="secondary" onclick="removeOpenAIKey()">Remove Key</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Ingestion Jobs Section -->
        <div id="section-jobs" class="section">
          <div class="section-header">
            <h1 class="section-title">Ingestion Jobs</h1>
            <p class="section-subtitle">Track the status of your content ingestion</p>
          </div>
          <div class="section-card">
            <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
              <button onclick="loadJobs()" style="font-size: 13px; padding: 8px 16px;">Refresh</button>
            </div>
            <div id="jobsList"><p style="color: #6b7280; text-align: center; padding: 20px;">Loading...</p></div>
          </div>
        </div>

        <!-- Knowledge Base Section -->
        <div id="section-knowledge" class="section">
          <div class="section-header">
            <h1 class="section-title">Knowledge Base</h1>
            <p class="section-subtitle">View and manage your ingested content chunks</p>
          </div>
          <div class="section-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div style="font-size: 14px; color: #6b7280;" id="knowledgeCount">0 chunks</div>
              <button onclick="loadKnowledge()" style="font-size: 13px; padding: 8px 16px;">Refresh</button>
            </div>
            <div id="knowledgeSearch" style="margin-bottom: 16px;">
              <input type="text" id="knowledgeSearchInput" placeholder="Search chunks..." oninput="filterKnowledge(this.value)" style="width: 100%;">
            </div>
            <div id="knowledgeList"><p style="color: #6b7280; text-align: center; padding: 20px;">Loading...</p></div>
          </div>
        </div>

        <!-- Widget Config Section -->
        <div id="section-widget" class="section">
          <div class="section-header">
            <h1 class="section-title">Widget Configuration</h1>
            <p class="section-subtitle">Customize your chat widget appearance and behavior</p>
          </div>
          <div class="section-card">
            <form id="configForm">
              <div class="form-group">
                <label>Brand Name</label>
                <input type="text" id="brandName" placeholder="Acme Corp">
              </div>
              <div class="form-group">
                <label>Tone</label>
                <select id="tone">
                  <option value="neutral">Neutral</option>
                  <option value="formal">Formal</option>
                  <option value="friendly">Friendly</option>
                </select>
              </div>
              <div class="form-group">
                <label>Primary Color</label>
                <input type="color" id="primaryColor" value="#2563eb">
              </div>
              <div class="form-group">
                <label>Welcome Message</label>
                <input type="text" id="welcomeMessage" placeholder="Hi! How can I help you?">
              </div>
              <div class="btn-group">
                <button type="button" class="secondary" onclick="loadConfig()">Load Current</button>
                <button type="submit">Save Config</button>
              </div>
            </form>
          </div>
        </div>

        <!-- Embed Code Section -->
        <div id="section-embed" class="section">
          <div class="section-header">
            <h1 class="section-title">Embed Code</h1>
            <p class="section-subtitle">Add this snippet to your website to enable the chat widget</p>
          </div>
          <div class="section-card">
            <p style="font-size: 13px; color: #6b7280; margin-bottom: 16px;">Copy this snippet and paste it into your website's HTML, just before the closing &lt;/body&gt; tag.</p>
            <div class="embed-code" id="embedCode">Loading...</div>
            <button class="copy-btn" onclick="copyEmbedCode()">Copy Code</button>
          </div>
        </div>

        <!-- Integrations Section -->
        <div id="section-connectors" class="section" style="max-width: 960px;">
          <div class="section-header">
            <h1 class="section-title">Integrations</h1>
            <p class="section-subtitle">Connect third-party apps to sync data into your knowledge base</p>
          </div>

          <div class="integrations-search">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>
            <input type="text" id="integrationsSearchInput" placeholder="Search integrations..." oninput="filterApps(this.value)">
          </div>

          <div id="connectedSection" class="connected-section" style="display: none;">
            <div class="connected-section-title">Connected</div>
            <div id="connectedGrid" class="app-grid"></div>
          </div>

          <div id="categoryTabs" class="category-tabs"></div>

          <div id="appsGrid" class="app-grid">
            <p style="color: #6b7280; text-align: center; padding: 20px; grid-column: 1/-1;">Loading...</p>
          </div>
        </div>

        <!-- Profile Section -->
        <div id="section-profile" class="section">
          <div class="section-header">
            <h1 class="section-title">Profile</h1>
            <p class="section-subtitle">Your account information</p>
          </div>
          <div class="section-card">
            <div class="profile-field">
              <div class="profile-label">Name</div>
              <div class="profile-value" id="profileName">-</div>
            </div>
            <div class="profile-field">
              <div class="profile-label">Site ID</div>
              <div class="profile-value" id="profileSiteId">-</div>
            </div>
            <div class="profile-field">
              <div class="profile-label">Email</div>
              <div class="profile-value" id="profileEmail">-</div>
            </div>
            <div class="profile-field">
              <div class="profile-label">Member Since</div>
              <div class="profile-value" id="profileCreated">-</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration - Update these for your environment
    const API_URL = 'http://localhost:8000';
    const TOKEN_KEY = 'orca_token';

    // --- Token management ---
    function getToken() {
      return sessionStorage.getItem(TOKEN_KEY);
    }

    function setToken(token) {
      sessionStorage.setItem(TOKEN_KEY, token);
    }

    function clearToken() {
      sessionStorage.removeItem(TOKEN_KEY);
    }

    // --- API helper ---
    async function apiCall(path, options = {}) {
      const token = getToken();
      const headers = options.headers || {};
      if (token) {
        headers['Authorization'] = `Bearer ${token}`;
      }
      if (options.body && typeof options.body === 'object' && !(options.body instanceof FormData)) {
        headers['Content-Type'] = 'application/json';
        options.body = JSON.stringify(options.body);
      }
      options.headers = headers;

      const res = await fetch(`${API_URL}${path}`, options);

      if (res.status === 401 && path !== '/api/v1/client/login') {
        clearToken();
        showLoginView();
        throw new Error('Session expired');
      }

      return res;
    }

    // --- View management ---
    function showLoginView() {
      document.body.classList.add('login-active');
      document.getElementById('loginView').classList.remove('hidden');
      document.getElementById('dashboardView').classList.add('hidden');
    }

    function showDashboardView() {
      document.body.classList.remove('login-active');
      document.getElementById('loginView').classList.add('hidden');
      document.getElementById('dashboardView').classList.remove('hidden');
    }

    // --- Sidebar toggle ---
    function toggleSidebar() {
      const dashboard = document.getElementById('dashboardView');
      dashboard.classList.toggle('collapsed');
    }

    function expandSidebarIfCollapsed() {
      const dashboard = document.getElementById('dashboardView');
      if (dashboard.classList.contains('collapsed')) {
        dashboard.classList.remove('collapsed');
      }
    }

    // --- Section navigation ---
    function showSection(sectionId) {
      // Hide all sections
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });

      // Show selected section
      const targetSection = document.getElementById('section-' + sectionId);
      if (targetSection) {
        targetSection.classList.add('active');
      }

      // Update nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.section === sectionId) {
          item.classList.add('active');
        }
      });
    }

    function logout() {
      clearToken();
      showLoginView();
    }

    // --- Alerts ---
    function showAlert(message, type = 'info', containerId = 'alerts') {
      const alerts = document.getElementById(containerId);
      const alert = document.createElement('div');
      alert.className = `alert ${type}`;
      alert.textContent = message;
      alerts.appendChild(alert);
      setTimeout(() => alert.remove(), 5000);
    }

    // --- API status ---
    async function checkApiStatus() {
      const statusDots = [document.getElementById('apiStatus'), document.getElementById('loginApiStatus')];
      const statusTexts = [document.getElementById('apiStatusText'), document.getElementById('loginApiStatusText')];

      try {
        const res = await fetch(`${API_URL}/health`);
        if (res.ok) {
          statusDots.forEach(dot => dot && dot.classList.remove('offline'));
          statusTexts.forEach(text => text && (text.textContent = 'API Connected'));
        } else {
          throw new Error();
        }
      } catch {
        statusDots.forEach(dot => dot && dot.classList.add('offline'));
        statusTexts.forEach(text => text && (text.textContent = 'API Offline'));
      }
    }

    // --- OAuth placeholder ---
    function showOAuthMessage() {
      showAlert('OAuth login coming soon. Please use email and password.', 'info', 'loginAlerts');
    }

    // --- Login ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Signing in...';

      try {
        const res = await apiCall('/api/v1/client/login', {
          method: 'POST',
          body: {
            email: document.getElementById('loginEmail').value,
            password: document.getElementById('loginPassword').value,
          },
        });

        const data = await res.json();
        if (res.ok) {
          setToken(data.token);
          document.getElementById('headerUser').textContent = data.customer.name;
          showDashboardView();
          loadDashboard();
        } else {
          showAlert(data.detail || 'Login failed', 'error', 'loginAlerts');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error', 'loginAlerts');
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Sign In';
      }
    });

    // --- Dashboard load ---
    async function loadDashboard() {
      handleOAuthReturn();
      await Promise.all([
        loadProfile(),
        loadConfig(),
        loadJobs(),
        loadKnowledge(),
        loadEmbedCode(),
        loadApps(),
      ]);
    }

    // --- Profile ---
    async function loadProfile() {
      try {
        const res = await apiCall('/api/v1/client/me');
        const data = await res.json();
        if (res.ok) {
          document.getElementById('profileName').textContent = data.name;
          document.getElementById('profileSiteId').textContent = data.site_id;
          document.getElementById('profileEmail').textContent = data.email || '-';
          document.getElementById('profileCreated').textContent = new Date(data.created_at).toLocaleDateString();
          document.getElementById('headerUser').textContent = data.name;
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Failed to load profile', 'error');
        }
      }
    }

    // --- Ingest URL ---
    document.getElementById('ingestUrlForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Ingesting...';

      try {
        const res = await apiCall('/api/v1/client/ingest/url', {
          method: 'POST',
          body: {
            url: document.getElementById('ingestUrl').value,
            max_pages: parseInt(document.getElementById('maxPages').value),
          },
        });

        const data = await res.json();
        if (res.ok) {
          showAlert(data.message, 'success');
          loadJobs();
        } else {
          showAlert(data.detail?.message || data.detail || 'Ingestion failed', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Ingest URL';
      }
    });

    // --- Ingest Text ---
    document.getElementById('ingestTextForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button');
      btn.disabled = true;
      btn.textContent = 'Ingesting...';

      try {
        const res = await apiCall('/api/v1/client/ingest/text', {
          method: 'POST',
          body: {
            title: document.getElementById('textTitle').value,
            text: document.getElementById('textContent').value,
          },
        });

        const data = await res.json();
        if (res.ok) {
          showAlert(data.message, 'success');
          e.target.reset();
          loadJobs();
        } else {
          showAlert(data.detail?.message || data.detail || 'Ingestion failed', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Ingest Text';
      }
    });

    // --- Widget Config ---
    async function loadConfig() {
      try {
        const res = await apiCall('/api/v1/client/config');
        const data = await res.json();
        if (res.ok) {
          if (data.brand_name) document.getElementById('brandName').value = data.brand_name;
          if (data.tone) document.getElementById('tone').value = data.tone;
          if (data.primary_color) document.getElementById('primaryColor').value = data.primary_color;
          if (data.welcome_message) document.getElementById('welcomeMessage').value = data.welcome_message;
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Failed to load config', 'error');
        }
      }
    }

    document.getElementById('configForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;

      const body = {};
      const brandName = document.getElementById('brandName').value;
      const tone = document.getElementById('tone').value;
      const primaryColor = document.getElementById('primaryColor').value;
      const welcomeMessage = document.getElementById('welcomeMessage').value;

      if (brandName) body.brand_name = brandName;
      if (tone) body.tone = tone;
      if (primaryColor) body.primary_color = primaryColor;
      if (welcomeMessage) body.welcome_message = welcomeMessage;

      try {
        const res = await apiCall('/api/v1/client/config', {
          method: 'PUT',
          body: body,
        });

        if (res.ok) {
          showAlert('Config updated!', 'success');
        } else {
          const data = await res.json();
          showAlert(data.detail?.message || data.detail || 'Failed to update config', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      } finally {
        btn.disabled = false;
      }
    });

    // --- Jobs ---
    async function loadJobs() {
      try {
        const res = await apiCall('/api/v1/client/jobs');
        const data = await res.json();
        if (res.ok) {
          const jobsList = document.getElementById('jobsList');
          if (data.jobs.length === 0) {
            jobsList.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No ingestion jobs yet</p>';
          } else {
            jobsList.innerHTML = data.jobs.map(job => `
              <div class="job-item">
                <div class="job-header">
                  <span>${job.source_type}: ${job.source_url || job.source_filename || 'N/A'}</span>
                  <span class="job-status ${job.status}">${job.status}</span>
                </div>
                <div class="job-details">
                  Chunks: ${job.chunks_created} | Created: ${new Date(job.created_at).toLocaleString()}
                </div>
              </div>
            `).join('');
          }
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          document.getElementById('jobsList').innerHTML = '<p style="color: #991b1b; text-align: center; padding: 20px;">Failed to load jobs</p>';
        }
      }
    }

    // --- Embed Code ---
    async function loadEmbedCode() {
      try {
        const res = await apiCall('/api/v1/client/embed-code');
        const data = await res.json();
        if (res.ok) {
          document.getElementById('embedCode').textContent = data.embed_code;
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          document.getElementById('embedCode').textContent = 'Failed to load embed code';
        }
      }
    }

    function copyEmbedCode() {
      const code = document.getElementById('embedCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        showAlert('Copied to clipboard!', 'success');
      });
    }

    // --- Knowledge Base ---
    let allChunks = [];

    async function loadKnowledge() {
      try {
        const res = await apiCall('/api/v1/client/knowledge');
        const data = await res.json();
        if (res.ok) {
          allChunks = data.chunks;
          document.getElementById('knowledgeCount').textContent = `${data.total} chunk${data.total !== 1 ? 's' : ''}`;
          renderKnowledge(allChunks);
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          document.getElementById('knowledgeList').innerHTML = '<p style="color: #991b1b; text-align: center; padding: 20px;">Failed to load knowledge base</p>';
        }
      }
    }

    function renderKnowledge(chunks) {
      const list = document.getElementById('knowledgeList');
      if (chunks.length === 0) {
        list.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px;">No chunks found</p>';
        return;
      }
      list.innerHTML = chunks.map(chunk => `
        <div class="job-item">
          <div class="job-header">
            <span style="font-weight: 500;">${chunk.source_title || 'Untitled'}</span>
            <span class="job-status completed">Chunk #${chunk.chunk_index}</span>
          </div>
          <div style="font-size: 13px; color: #374151; margin-top: 8px; line-height: 1.5; white-space: pre-wrap; max-height: 80px; overflow: hidden;">${(chunk.content_preview || '').replace(/</g, '&lt;')}</div>
          <div class="job-details" style="display: flex; gap: 16px; margin-top: 6px;">
            ${chunk.source_url ? `<span>Source: ${chunk.source_url}</span>` : ''}
            ${chunk.token_count ? `<span>Tokens: ${chunk.token_count}</span>` : ''}
            <span>${new Date(chunk.created_at).toLocaleString()}</span>
          </div>
        </div>
      `).join('');
    }

    function filterKnowledge(query) {
      if (!query) {
        renderKnowledge(allChunks);
        return;
      }
      const q = query.toLowerCase();
      const filtered = allChunks.filter(c =>
        (c.content_preview || '').toLowerCase().includes(q) ||
        (c.source_title || '').toLowerCase().includes(q) ||
        (c.source_url || '').toLowerCase().includes(q)
      );
      renderKnowledge(filtered);
    }

    // --- Tab switching ---
    function showIngestTab(tab) {
      document.querySelectorAll('[data-ingest-tab]').forEach(t => {
        t.classList.toggle('active', t.dataset.ingestTab === tab);
      });

      document.getElementById('ingestUrlForm').classList.toggle('hidden', tab !== 'url');
      document.getElementById('ingestTextForm').classList.toggle('hidden', tab !== 'text');
      document.getElementById('ingestFileForm').classList.toggle('hidden', tab !== 'file');
      document.getElementById('ingestApiKeysForm').classList.toggle('hidden', tab !== 'apikeys');

      if (tab === 'apikeys') {
        loadApiKeys();
      }
    }

    // --- API Keys ---
    async function loadApiKeys() {
      try {
        const res = await apiCall('/api/v1/client/api-keys');
        const data = await res.json();
        if (res.ok) {
          document.getElementById('clientApiKeyDisplay').value = data.api_key_masked;
          const statusEl = document.getElementById('openaiKeyStatus');
          if (data.has_openai_key) {
            statusEl.innerHTML = `<span style="color: #166534;">Current key: <code style="background: #f0fdf4; padding: 2px 6px; border-radius: 4px;">${data.openai_key_masked}</code></span>`;
          } else {
            statusEl.innerHTML = '<span style="color: #6b7280;">No key set â€” using platform key</span>';
          }
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Failed to load API keys', 'error');
        }
      }
    }

    function copyClientApiKey() {
      const val = document.getElementById('clientApiKeyDisplay').value;
      navigator.clipboard.writeText(val).then(() => {
        showAlert('Masked key copied to clipboard', 'success');
      });
    }

    function copyNewClientApiKey() {
      const val = document.getElementById('clientApiKeyFullValue').value;
      navigator.clipboard.writeText(val).then(() => {
        showAlert('New API key copied to clipboard', 'success');
      });
    }

    async function regenerateApiKey() {
      if (!confirm('Are you sure you want to regenerate your API key? The old key will stop working immediately.')) {
        return;
      }

      try {
        const res = await apiCall('/api/v1/client/api-keys/regenerate', { method: 'POST' });
        const data = await res.json();
        if (res.ok) {
          document.getElementById('clientApiKeyFullValue').value = data.api_key;
          document.getElementById('clientApiKeyFull').classList.remove('hidden');
          // Refresh the masked display
          loadApiKeys();
        } else {
          showAlert(data.detail || 'Failed to regenerate key', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      }
    }

    async function saveOpenAIKey() {
      const key = document.getElementById('openaiKeyInput').value.trim();
      if (!key || key.length < 10) {
        showAlert('Please enter a valid OpenAI API key (at least 10 characters)', 'error');
        return;
      }

      try {
        const res = await apiCall('/api/v1/client/api-keys/openai', {
          method: 'PUT',
          body: { openai_api_key: key },
        });
        const data = await res.json();
        if (res.ok) {
          showAlert(data.message, 'success');
          document.getElementById('openaiKeyInput').value = '';
          loadApiKeys();
        } else {
          showAlert(data.detail?.message || data.detail || 'Failed to save key', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      }
    }

    async function removeOpenAIKey() {
      if (!confirm('Remove your OpenAI API key? The platform key will be used instead.')) {
        return;
      }

      try {
        const res = await apiCall('/api/v1/client/api-keys/openai', { method: 'DELETE' });
        const data = await res.json();
        if (res.ok) {
          showAlert(data.message, 'success');
          loadApiKeys();
        } else {
          showAlert(data.detail || 'Failed to remove key', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      }
    }

    function toggleOpenAIKeyVisibility() {
      const input = document.getElementById('openaiKeyInput');
      const icon = document.getElementById('openaiKeyEyeIcon');
      if (input.type === 'password') {
        input.type = 'text';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />';
      } else {
        input.type = 'password';
        icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />';
      }
    }

    // --- Integrations ---
    let allApps = [];
    let activeCategory = 'All';
    let searchQuery = '';

    async function loadApps() {
      try {
        const res = await apiCall('/api/v1/client/connectors/apps');
        const data = await res.json();
        if (res.ok) {
          allApps = data.apps;
          renderCategoryTabs(data.categories);
          renderApps();
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          document.getElementById('appsGrid').innerHTML = '<p style="color: #991b1b; text-align: center; padding: 20px; grid-column: 1/-1;">Failed to load integrations</p>';
        }
      }
    }

    function renderCategoryTabs(categories) {
      const container = document.getElementById('categoryTabs');
      const tabs = ['All', ...categories];
      container.innerHTML = tabs.map(cat =>
        `<button class="category-tab${cat === activeCategory ? ' active' : ''}" onclick="setCategory('${cat.replace(/'/g, "\\'")}')">${cat}</button>`
      ).join('');
    }

    function setCategory(cat) {
      activeCategory = cat;
      document.querySelectorAll('.category-tab').forEach(t => {
        t.classList.toggle('active', t.textContent === cat);
      });
      renderApps();
    }

    function filterApps(query) {
      searchQuery = query.toLowerCase();
      renderApps();
    }

    function renderApps() {
      const connectedGrid = document.getElementById('connectedGrid');
      const connectedSection = document.getElementById('connectedSection');
      const appsGrid = document.getElementById('appsGrid');

      // Collect all connected apps
      let connectedCards = [];
      let availableCards = [];

      allApps.forEach(app => {
        // Filter by category
        if (activeCategory !== 'All' && app.category !== activeCategory) return;

        // Filter by search query
        if (searchQuery) {
          const nameMatch = app.display_name.toLowerCase().includes(searchQuery);
          const descMatch = app.description.toLowerCase().includes(searchQuery);
          const accountMatch = app.connections.some(c =>
            (c.external_account_name || '').toLowerCase().includes(searchQuery)
          );
          if (!nameMatch && !descMatch && !accountMatch) return;
        }

        // Render connected instances
        app.connections.forEach(conn => {
          connectedCards.push(renderConnectedCard(app, conn));
        });

        // Render available app card
        availableCards.push(renderAppCard(app));
      });

      // Connected section
      if (connectedCards.length > 0) {
        connectedSection.style.display = '';
        connectedGrid.innerHTML = connectedCards.join('');
      } else {
        connectedSection.style.display = 'none';
        connectedGrid.innerHTML = '';
      }

      // Available apps
      if (availableCards.length > 0) {
        appsGrid.innerHTML = availableCards.join('');
      } else {
        appsGrid.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 20px; grid-column: 1/-1;">No apps match your search</p>';
      }
    }

    function renderConnectedCard(app, connection) {
      const dotClass = connection.connection_status === 'connected' ? 'green' :
                       connection.connection_status === 'error' ? 'red' : 'gray';
      const accountLabel = connection.external_account_name || connection.display_name;
      const syncBtn = connection.is_syncable
        ? `<button class="sync-btn" onclick="syncConnector('${connection.id}')">Sync</button>`
        : '';
      const statusTip = connection.status_message ? ` title="${connection.status_message}"` : '';

      return `
        <div class="app-card connected">
          <div class="app-card-icon">
            ${app.icon ? `<img src="${app.icon}" alt="${app.display_name}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span class="fallback-icon" style="display:none">${app.display_name[0]}</span>` : `<span class="fallback-icon">${app.display_name[0]}</span>`}
          </div>
          <div class="app-card-info">
            <div class="app-card-name">${app.display_name}</div>
            <div class="app-card-account"${statusTip}>
              <span class="connection-dot ${dotClass}"></span>
              ${accountLabel}
            </div>
          </div>
          <div class="app-card-actions">
            ${syncBtn}
            <button class="disconnect-btn" onclick="disconnectApp('${connection.id}', '${app.display_name.replace(/'/g, "\\'")}')">Disconnect</button>
          </div>
        </div>`;
    }

    function renderAppCard(app) {
      let actionBtn;
      if (app.provider_id === 'custom') {
        actionBtn = `<button class="connect-btn" onclick="connectCustomApp()">Add</button>`;
      } else if (!app.is_connectable) {
        actionBtn = `<button class="connect-btn coming-soon" disabled>Coming Soon</button>`;
      } else if (app.connections.length > 0) {
        actionBtn = `<button class="connect-btn" onclick="connectApp('${app.provider_id}')">+ Add Account</button>`;
      } else {
        actionBtn = `<button class="connect-btn" onclick="connectApp('${app.provider_id}')">Connect</button>`;
      }

      return `
        <div class="app-card">
          <div class="app-card-icon">
            ${app.icon ? `<img src="${app.icon}" alt="${app.display_name}" onerror="this.style.display='none';this.nextElementSibling.style.display='block'"><span class="fallback-icon" style="display:none">${app.display_name[0]}</span>` : `<span class="fallback-icon">${app.display_name[0]}</span>`}
          </div>
          <div class="app-card-info">
            <div class="app-card-name">${app.display_name}</div>
            <div class="app-card-desc">${app.description}</div>
          </div>
          <div class="app-card-actions">
            ${actionBtn}
          </div>
        </div>`;
    }

    async function connectApp(providerId) {
      try {
        const res = await apiCall(`/api/v1/client/connectors/oauth/${providerId}/authorize`);
        const data = await res.json();
        if (res.ok) {
          // Redirect the browser to the OAuth provider
          window.location.href = data.authorization_url;
        } else {
          showAlert(data.detail || 'Failed to start connection', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      }
    }

    function connectCustomApp() {
      // For custom connectors, keep simple prompt-based flow
      const name = prompt('Enter a name for this custom connector:');
      if (!name) return;
      const key = prompt('Enter credential key (e.g. api_key):');
      if (!key) return;
      const value = prompt('Enter credential value:');
      if (!value) return;

      apiCall('/api/v1/client/connectors/', {
        method: 'POST',
        body: { app_name: 'custom', display_name: name, credentials: { [key]: value } },
      }).then(res => res.json()).then(data => {
        if (data.id) {
          showAlert('Custom connector created', 'success');
          loadApps();
        } else {
          showAlert(data.detail || 'Failed to create connector', 'error');
        }
      }).catch(() => showAlert('Network error', 'error'));
    }

    async function disconnectApp(connectorId, appName) {
      if (!confirm(`Disconnect ${appName}? This will remove the connection.`)) return;

      try {
        const res = await apiCall(`/api/v1/client/connectors/${connectorId}/disconnect`, { method: 'POST' });
        if (res.ok) {
          showAlert(`${appName} disconnected`, 'success');
          loadApps();
        } else {
          const data = await res.json();
          showAlert(data.detail || 'Failed to disconnect', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') showAlert('Network error', 'error');
      }
    }

    async function syncConnector(id) {
      showAlert('Syncing... this may take a moment.', 'info');

      try {
        const res = await apiCall(`/api/v1/client/connectors/${id}/sync`, { method: 'POST' });
        const data = await res.json();
        if (res.ok) {
          showAlert(data.message, 'success');
          loadApps();
          loadJobs();
          loadKnowledge();
        } else {
          showAlert(data.detail?.message || data.detail || 'Sync failed', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') showAlert('Network error', 'error');
      }
    }

    function handleOAuthReturn() {
      const params = new URLSearchParams(window.location.search);
      const success = params.get('oauth_success');
      const error = params.get('oauth_error');

      if (success) {
        showToast(`Successfully connected ${success.replace(/_/g, ' ')}!`, 'success');
        // Clean URL
        window.history.replaceState({}, document.title, window.location.pathname);
      } else if (error) {
        showToast(`Connection failed: ${error.replace(/_/g, ' ')}`, 'error');
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }

    // --- File upload ---
    let selectedFile = null;

    const FILE_CATEGORY_ICONS = {
      document: '\u{1F4C4}',
      image: '\u{1F5BC}',
      audio: '\u{1F3B5}',
      video: '\u{1F3AC}',
    };

    const FILE_CATEGORIES = {
      '.pdf': 'document', '.docx': 'document', '.pptx': 'document', '.xlsx': 'document',
      '.csv': 'document', '.txt': 'document', '.md': 'document', '.json': 'document',
      '.jpg': 'image', '.jpeg': 'image', '.png': 'image', '.gif': 'image',
      '.webp': 'image', '.bmp': 'image', '.tiff': 'image',
      '.mp3': 'audio', '.wav': 'audio', '.m4a': 'audio', '.ogg': 'audio',
      '.flac': 'audio', '.webm': 'audio',
      '.mp4': 'video', '.mov': 'video',
    };

    function getFileCategory(filename) {
      const ext = '.' + filename.split('.').pop().toLowerCase();
      return FILE_CATEGORIES[ext] || null;
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    function showFilePreview(file) {
      const category = getFileCategory(file.name);
      if (!category) {
        showAlert('Unsupported file type', 'error');
        return;
      }

      const preview = document.getElementById('filePreview');
      preview.classList.remove('hidden');
      preview.innerHTML = `
        <div class="file-preview">
          <div class="file-preview-icon ${category}">${FILE_CATEGORY_ICONS[category]}</div>
          <div class="file-preview-info">
            <div class="file-preview-name">${file.name}</div>
            <div class="file-preview-meta">
              <span>${formatFileSize(file.size)}</span>
              <span class="file-category-badge ${category}">${category}</span>
            </div>
          </div>
          <button class="file-preview-remove" onclick="clearFileSelection()" title="Remove">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
      `;
      document.getElementById('uploadFileBtn').disabled = false;
    }

    function clearFileSelection() {
      selectedFile = null;
      document.getElementById('fileInput').value = '';
      document.getElementById('filePreview').classList.add('hidden');
      document.getElementById('filePreview').innerHTML = '';
      document.getElementById('uploadFileBtn').disabled = true;
    }

    // Drop zone events
    (function setupDropZone() {
      const dropZone = document.getElementById('fileDropZone');
      const fileInput = document.getElementById('fileInput');
      if (!dropZone || !fileInput) return;

      dropZone.addEventListener('click', () => fileInput.click());

      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length > 0) {
          selectedFile = e.dataTransfer.files[0];
          showFilePreview(selectedFile);
        }
      });

      fileInput.addEventListener('change', () => {
        if (fileInput.files.length > 0) {
          selectedFile = fileInput.files[0];
          showFilePreview(selectedFile);
        }
      });
    })();

    async function uploadFile() {
      if (!selectedFile) return;

      const btn = document.getElementById('uploadFileBtn');
      btn.disabled = true;
      btn.textContent = 'Uploading...';

      try {
        const formData = new FormData();
        formData.append('file', selectedFile);

        const res = await apiCall('/api/v1/client/ingest/file', {
          method: 'POST',
          body: formData,
        });

        const data = await res.json();
        if (res.ok) {
          showAlert(data.message, 'success');
          clearFileSelection();
          loadJobs();
        } else {
          showAlert(data.detail?.message || data.detail || 'Upload failed', 'error');
        }
      } catch (err) {
        if (err.message !== 'Session expired') {
          showAlert('Network error', 'error');
        }
      } finally {
        btn.disabled = false;
        btn.textContent = 'Upload File';
      }
    }

    // --- Initialize ---
    async function init() {
      checkApiStatus();
      setInterval(checkApiStatus, 30000);

      const token = getToken();
      if (token) {
        // Validate token by loading profile
        try {
          const res = await apiCall('/api/v1/client/me');
          if (res.ok) {
            showDashboardView();
            loadDashboard();
          } else {
            clearToken();
            showLoginView();
          }
        } catch {
          showLoginView();
        }
      } else {
        showLoginView();
      }
    }

    init();

    // --- Ocean Wave Particle Field ---
    (function() {
      const canvas = document.getElementById('particleWave');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      let animationId;
      let time = 0;
      let width, height;

      function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
      }

      function drawOceanWave() {
        ctx.clearRect(0, 0, width, height);

        const dotSpacing = 12;
        const cols = Math.ceil(width / dotSpacing) + 1;
        const rows = 45;

        // Wave starts from middle-bottom area
        const startY = height * 0.55;
        const waveDepth = height * 0.45;

        for (let row = 0; row < rows; row++) {
          // Perspective factor - rows further back (higher row number) appear higher and compressed
          const rowRatio = row / rows;
          const perspective = 1 - rowRatio * 0.85;

          // Y position - further rows are higher on screen (perspective)
          const baseY = startY + waveDepth * (1 - Math.pow(rowRatio, 0.7));

          // Row-based opacity - fade toward horizon (more subtle)
          const rowOpacity = Math.pow(1 - rowRatio, 0.6) * 0.25;

          // Dot size decreases with distance (smaller dots)
          const baseDotSize = 0.9 * perspective + 0.2;

          for (let col = 0; col < cols; col++) {
            const x = col * dotSpacing;

            // Ocean wave function - multiple rolling swells
            const xNorm = x / width;
            const zNorm = row / rows;

            // Primary swell - large rolling wave moving forward
            const swell1 = Math.sin((zNorm * 8) - time * 0.4 + xNorm * 2) * 25 * perspective;

            // Secondary swell - offset angle
            const swell2 = Math.sin((zNorm * 12) - time * 0.3 + xNorm * 1.5 + 2) * 12 * perspective;

            // Gentle cross-wave
            const cross = Math.sin((xNorm * 6) + (zNorm * 4) - time * 0.2) * 8 * perspective;

            // Combine waves
            const waveY = swell1 + swell2 + cross;

            const y = baseY - waveY;

            // Skip if outside visible area
            if (y < 0 || y > height) continue;

            // Slight variation in opacity based on wave height (brighter at peaks)
            const heightBoost = Math.max(0, waveY / 40) * 0.05;
            const opacity = Math.min(0.3, rowOpacity + heightBoost);

            // Draw dot
            ctx.beginPath();
            ctx.arc(x, y, baseDotSize, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(120, 120, 120, ${opacity})`;
            ctx.fill();
          }
        }
      }

      function animate() {
        time += 0.015;
        drawOceanWave();
        animationId = requestAnimationFrame(animate);
      }

      // Initialize
      resize();
      window.addEventListener('resize', resize);
      animate();

      // Cleanup when leaving login page
      const observer = new MutationObserver(() => {
        const loginView = document.getElementById('loginView');
        if (loginView && loginView.classList.contains('hidden')) {
          cancelAnimationFrame(animationId);
        } else if (loginView && !loginView.classList.contains('hidden')) {
          cancelAnimationFrame(animationId);
          animate();
        }
      });

      observer.observe(document.getElementById('loginView'), { attributes: true });
    })();
  </script>
</body>
</html>
